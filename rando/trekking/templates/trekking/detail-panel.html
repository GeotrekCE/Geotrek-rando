{% load static i18n leaflet_tags trekking localeurl_tags %}

{% include "trekking/navigation_fragment.html" %}
{% include "trekking/share_fragment.html" with title=object.title %}

{% if pjax %}
  <title>{{ object.title }}</title>
{% endif %}

<div id="mobile-header-detail">
  <a class="pjax" href="{% locale_url request.LANGUAGE_CODE trekking:home %}"><i class="icon-chevron-left icon-white"></i><h1>{% trans "Back to list" %}</h1></a>
</div>

<div class="detail-content">
  <div class="row-fluid" id="detail-content-top">
    {% include "trekking/fake_searchtabs_fragment.html" %}

    <div class="span4 pull-right">
      <div id="toolbox" class="btn-toolbar pull-right">
        <a class="btn backpack" href="#" data-pk="{{ trek.properties.pk }}" data-name="{{ trek.properties.name }}"><i class="backpack"></i> {% trans "Favorites" %}</a>

        {% if VIEW3D_ENABLED %}
        <a class="btn download view3d" title="{% trans "3D View" %}">
          <i class="view3d"></i> {% trans "3D" %}
        </a>
        {% endif %}

        {% if PRINT_ENABLED %}
        <a class="btn download print" title="{% trans "Print" %}" href="{% locale_url request.LANGUAGE_CODE trekking:fileserve object.properties.printable %}" target="_blank">
          <i class="print"></i> {% trans "Print" %}
        </a>
        {% else %}
        <a class="btn download print disabled" title="{% trans "Soon!" %}" >
          <i class="print"></i> {% trans "Print" %}
        </a>
        {% endif %}
        <a class="btn download gpx" title="{% trans "Download GPX" %}" href="{% locale_url request.LANGUAGE_CODE trekking:fileserve object.properties.gpx %}">
          <i class="gpx"></i> {% trans "GPX" %}
        </a>
        <a class="btn download kml" title="{% trans "Download for Google Earth" %}" href="{% locale_url request.LANGUAGE_CODE trekking:fileserve object.properties.kml %}">
          <i class="kml"></i> {% trans "KML" %}
        </a>

      </div>
    </div>
  </div>

  <div class="row-fluid" id="detail-content-title">
    <div class="span5 title">
      <h2>{{ object.properties.name }}</h2>
      <h3 id="departure-arrival">{% trans "Departure" %} : {{ object.properties.departure }}{% if object.properties.arrival %} &rarr; {% trans "Arrival" %} : {{ object.properties.arrival }}{% endif %}</h3>
    </div>
    <div class="span7">
      <div class="row-fluid" id="trek-identity">
        <div class="span3">
          <p>{% trans "Duration" %} : <span class="value">{{ object.properties.duration|duration }}</span></p>
          <p>{% trans "Difficulty" %} : <span class="value">{{ object.properties.difficulty.label }}</span></p>
          <p>{% trans "Ascent" %} : <span class="value">{{ object.properties.ascent }} m</span></p>
        </div>
        <div class="span3">
          {% if object.properties.route %}
          <p>{% trans "Total Length" %} : <span class="value">{{ object.properties.length|kilo|floatformat }} km</span></p>
          <p>{% trans "Route" %} : <span class="value">{{ object.properties.route.label }}</span></p>
          {% endif %}
          <p>{% trans "Valleys" %} : <span class="value">{% for district in object.properties.districts %}
            {{ district.name }}{% if object.properties.districts|length > 1 %},{% endif %} {% endfor %}</span></p>
        </div>

        {% for usage in object.properties.usages %}
          {% if forloop.first %}<div id="usages">Usages<ul>{% endif %}
          <li>{{ usage|pictogram:"medium" }}</li>
          {% if forloop.last %}</ul></div>{% endif %}
        {% endfor %}
        
        {% for theme in object.properties.themes %}
          {% if forloop.first %}<div id="themes">Th√®mes<ul>{% endif %}
          <li>{{ theme|pictogram:"medium" }}</li>
          {% if forloop.last %}</ul></div>{% endif %}
        {% endfor %}

      </div>
    </div>
  </div>

  <div id="detail-container-content" class="row-fluid">
    <div class="span4">
      <p class="teaser">{{ object.properties.description_teaser|default:"No teaser"|safe|striptags }}</p>
      <p>{{ object.properties.ambiance|default:"No ambiance"|safe }}</p>

      <div id="trek-carousel">
        {% include "trekking/carousel_fragment.html" with prefix="trek" pictures=all_pictures default="True" %}
      </div>

      <p>{{ object.properties.description|default:"No description"|safe }}</p>

      {% if object.properties.disabled_infrastructure %}
      <div id="trek-disabled">
        <h3> {% trans "Disabled-friendly infrastructures" %}</h3>
        <p>{{ object.properties.disabled_infrastructure|safe }}</p>
      </div>
      {% endif %}

      {% if object.properties.public_transport %}
      <div id="trek-transport">
        <h3>{% trans "Transport" %}</h3>
        <p>{{ object.properties.public_transport|safe }}</p>
      </div>
      {% endif %}

      {% if object.properties.access %}
      <div id="trek-access" class="alert alert-info">
        <h3>{% trans "Access" %}</h3>
        <p>{{ object.properties.access|safe }}</p>
      </div>
      {% endif %}

     {% if object.properties.information_desk %}
        <div id="trek-information-desk">
          <h3>{% trans "Information Desk" %}</h3>
          <p class="title">{{ object.properties.information_desk.name }}</p>
          <p>{{ object.properties.information_desk.description|safe }}</p>
        </div>
      {% endif %}

    </div>

    <div class="span{% if pois %}4{% else %}8{% endif %}">
      {% if object.properties.is_park_centered %}
        <div id="park-center-warning" class="alert alert-info">
            <p><strong>{% trans "This trek is within park center" %}</strong>, <a class="pjax" href="{% locale_url request.LANGUAGE_CODE flatpages:redirect "1" %}">{% trans "please read access rules." %}</a></p>
        </div>
      {% endif %}

      <div id="detailmap">
        <img id="staticmap" class="hidden" src="{% locale_url request.LANGUAGE_CODE trekking:fileserve object.properties.map_image_url %}"/>
        <div class="helpclic"><p>{% trans "Clic for map interaction" %}</p></div>
      </div>

      <div id="altitudegraph">
        <h4>{% trans "Altitude profile" %}</h4>
        <p class="axislabel">{% trans "Altitude (m)" %}</p>
         <p id="altitude-details">
          <span class="min">{% trans "Min" %} : <span class="value">{{ object.properties.min_elevation }} m</span></span> - 
          <span class="max">{% trans "Max" %} : <span class="value">{{ object.properties.max_elevation }} m</span></span>
        </p>
        <span id="profilealtitude"></span> <span class="axislabel">{% trans "Distance (m)" %}</span>
        <p id="mouseoverprofil" class="axislabel" >&nbsp;</p>
      </div>

      <div class="row-fluid meta">
        {% if object.properties.web_links|length > 0 %}
        <div class="flex">
          <div id="trek-links">
            <h4>{% trans "See also" %}</h4>

            {% regroup object.properties.web_links by category as weblinks %}

            <ul>
            {% for weblink in weblinks %}
                <h5><img src="{{ weblink.grouper.pictogram }}"> {{ weblink.grouper.label }}</h5>
                <li>
                {% for item in weblink.list %}
                  {% if forloop.first and weblink.list.count > 1 %}<ul>{% endif %}
                  {% if weblink.list.count > 1 %}<li>{% endif %}
                  <a target="_blank" href="{{ item.url }}">{{ item.name }}</a>
                  {% if weblink.list.count > 1 %}</li>{% endif %}
                  {% if forloop.last and weblink.list.count > 1 %}</ul>{% endif %}
                {% endfor %}
                </li>
            {% endfor %}
            </ul>
          </div>
        </div>
        {% endif %}

        {% if object.properties.relationships_departure|length > 0 or object.properties.relationships_edge|length > 0 or object.properties.relationships_circuit|length > 0 %}
        <div id="trek-related" class="flex">
          <h4>{% trans "Related treks" %}</h4>
          {% for relationship in object.properties.relationships_departure %}
            {% if forloop.first %}
              <h5>{% trans "Sharing departure" %}</h5>
              <ul>
            {% endif %}
            <li><a href="{% locale_url request.LANGUAGE_CODE trekking:detail relationship.trek.slug %}">{{ relationship.trek.name }}</a></li>
            {% if forloop.last %}</ul>{% endif %}
          {% endfor %}

          {% for relationship in object.properties.relationships_edge %}
            {% if forloop.first %}
              <h5>{% trans "Sharing paths" %}</h5>
              <ul>
            {% endif %}
            <li><a href="{% locale_url request.LANGUAGE_CODE trekking:detail relationship.trek.slug %}">{{ relationship.trek.name }}</a></li>
            {% if forloop.last %}</ul>{% endif %}
          {% endfor %}

          {% for relationship in object.properties.relationships_circuit %}
            {% if forloop.first %}
              <h5>{% trans "Sharing circuit" %}</h5>
              <ul>
            {% endif %}
            <li><a href="{% locale_url request.LANGUAGE_CODE trekking:detail relationship.trek.slug %}">{{ relationship.trek.name }}</a></li>
            {% if forloop.last %}</ul>{% endif %}
          {% endfor %}
        </div>
        {% endif %}
      </div>

     {% if object.properties.advice %}
        <div id="trek-advice" class="alert alert-error">
          <h3>{% trans "Advice" %}</h3>
          <p>{{ object.properties.advice|safe }}</p>
        </div>
      {% endif %}

    </div>

    {% if pois %}
    <div class="span4">

      <h5>{% trans "On the way..." %}</h5>

      <div class="accordion" id="pois-accordion">
        {% for poi in pois %}
        <div class="accordion-group">
          <div class="accordion-heading">
            <a class="accordion-toggle acc-open" id="poi-item-{{ poi.properties.pk}}" data-toggle="collapse" data-parent="#pois-accordion" data-id="{{ poi.properties.pk }}" href="#collapse-poi-{{  poi.properties.pk }}">
              {{ poi.properties.type|pictogram }}
              {{ poi.properties.name }}
              {% if poi.properties.pictures|length > 0 %}
                <span class="pictures-info pull-right"><i class="icon-camera icon-gray"></i>&times;{{ poi.properties.pictures|length }}</span>
              {% endif %}
            </a>
          </div>
          <div id="collapse-poi-{{  poi.properties.pk }}" class="accordion-body collapse" style="height: 0px; " data-id="{{ poi.properties.pk }}">
            <div class="accordion-inner">
              <p>{{ poi.properties.description|safe }}</p>
              {% include "trekking/carousel_fragment.html" with prefix=poi.properties.pk pictures=poi.properties.pictures default="False" %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

  </div><!-- detail-container-content -->
</div><!-- detail-content -->

<script type="text/javascript">
    window.trek = {{ trek.geojson|safe }};
    window.pois = {{ poisjson|safe }};
    window.altimetric_url = "{% locale_url request.LANGUAGE_CODE trekking:fileserve object.properties.altimetric_profile %}";
    window.view3d_url = "{% locale_url request.LANGUAGE_CODE trekking:view3d "empty" %}";
</script>

{% leaflet_map 'detailmap' fitextent=False creatediv=False loadevent="rando:foo" %}{# Such loadevent will prevent automatic map initialization #}
